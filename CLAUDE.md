# CLAUDE.md

## プロジェクト概要

このプロジェクトは、生成AIのテキスト生成および理解機能を活用して、英文の読み書きを練習できるWebアプリケーションを開発することを目的としています。　　
ユーザは英会話講師（生成AIによるロールプレイ）とさまざまな会話をしながら、英語力の向上を図ることができます。
英文同士でやりとりするだけでなく、英文の和訳を表示したり、ライティングに対するアドバイスを受けたり、追加の質問を投げかけることができます。

## 利用者と利用環境

- **想定利用者**: 開発者本人（私）  
- **公開範囲**: 一般公開の予定はなく、ローカル環境での利用を想定しています。  
- **実行環境**: ローカルマシン上での実行を前提とし、特別なデプロイ環境は必要ありません。

## 技術スタック

- **バックエンド**: Python
  - Flask を使用したHTTP APIサーバー
  - 主な役割: Anthropic/OpenAI APIへのリクエスト中継と結果の受け渡し
  - Anthropic API と OpenAI API の両対応（ユーザー選択可能）
- **フロントエンド**: 
  - HTML/CSS/JavaScript（シンプルな構成）
  - 静的ファイルとして配信
- **データ保存**: 
  - ローカルファイルシステム（JSON形式設定ファイル）
  - ブラウザのローカルストレージも活用
- **開発環境**:
  - ローカル開発・実行
  - APIキーは設定ファイルまたは環境変数で管理

## プロジェクト構造

```
EnglishLearning/
├── README.md
├── CLAUDE.md
├── requirements.txt
├── main.py                 # アプリケーションエントリーポイント
├── config/
│   ├── __init__.py
│   ├── settings.py         # 設定管理クラス
│   └── config.json         # 設定ファイル
├── backend/
│   ├── __init__.py
│   ├── app.py             # Flaskアプリケーション
│   ├── ai_service.py      # AI API統合クラス
│   └── prompts.py         # プロンプト管理クラス
├── frontend/
│   ├── index.html
│   └── static/
│       ├── css/
│       │   └── style.css
│       └── js/
│           └── app.js
└── data/                  # 将来的なデータ保存用
```

## 機能要件

- 生成AIのルールプレイによる英語の先生とテキストで会話ができる。
- 会話のモードはバリエーションがある。
  - フリートピックスで英語の先生と自由に会話してもよいし、何かしらの課題（要約・テーマ指定のエッセイ作成・英語表現や英語圏の文化についてのクイズなど）を与えられてそれに回答することもできる。
  - これはユーザがいつでも切り替えできる。ドロップダウンリストのような形式で変更できる。
- すべての英文は和訳を表示できる。
- 英語の先生とのやりとりとは別に、ユーザのテキストに対するフィードバックも受けられる。より適切で自然な表現を提案してくれる校閲のような役割。
- 画面は縦に三分割される。中央が英語の先生とのやりとり、左側が和訳、右側はテキストに対するフィードバック。
- ユーザは英語のレベルを設定できる。例えば、Toeicで400点相当、600点相当、800点相当、から選ぶ感じ。
- ユーザーインターフェースはシンプルで直感的なデザインとする
- ライトモードとダークモードにも対応する。ユーザはいつでも自由にデザインを変更できる。
- これまでの会話をリセットして、一から会話を始められるボタンがある


## 開発方針

- コードはシンプルで読みやすく保つ
- 外部ライブラリの使用は最小限に抑える
- セキュリティ上の懸念がない限り、ローカル環境での迅速な開発を優先する
- このプログラム自体を外部に公開するつもりはないので、セキュリティ対策は最小限でよい。特に、運用が複雑になるようなことは避ける
- モジュール化とファイル分割により、今後の機能拡張と保守を容易にする
- 設定ファイルベースの管理により、コードを変更せずに動作をカスタマイズできるようにする

## アプリケーションの起動方法

```bash
# 依存関係のインストール
pip install -r requirements.txt

# アプリケーションの起動
python main.py
```

起動後、ブラウザで http://localhost:8000 にアクセスしてください。

## Claudeへの指示

Claudeには以下の点を考慮して支援をお願いしたい：

- 上記の技術スタックと機能要件に基づいてコードの提案や修正を行う
- コードの可読性と保守性を重視する
- 不明点や曖昧な仕様がある場合は、明確化のための質問を提示する
- プロジェクトの目的と利用環境を常に念頭に置いて支援を行う
- 一度に複数のタスクを解くことなく、まとまりのある１つの単位で作業すること。
  - 実装だけで終わらず、必ず動作確認まですること。重要な場合などをのぞき、個人用のアプリなので網羅的なテストなどは不要で、基本動作を確認するくらいでよいです。
  - ユーザによる動作確認が必要な場合は連絡すること。
  - 作業完了時にはCLAUDE.mdにも反映すること。
  - 実装が終わったらgitに反映すること。
- 生成AIのプロンプトを変更する際は、必ずユーザが内容を確認したあとで変更を反映すること。


## 改善メモ

### 高優先度（バグ修正・重要なUX改善）
- **[重要]** エラーをはじめとしたシステムメッセージの表示を改善
  - 現在はAI Teacherのメッセージに見える形でエラーが表示される
  - システムメッセージとして明確に区別できる表示に変更

### 中優先度（ユーザビリティ向上）
- ブラウザの横幅を小さくしたときのUIを改善する
  - 先生とのチャットがメインなので、少なくともこれが一番上にくるべき
  - ３つの要素が縦に並ぶのは決して見やすくない。他の見せ方があるならそれの方が望ましい。
- Text Feedbackでも、履歴を見れるようにする
  - 和訳の履歴を見られるのと同じ感じ。
  - ユーザのどの投稿に対応するフィードバックなのかがわかるように、IDを記載する。（これも和訳と同様。）
- **画面右のフィードバック、全体的に文章が長いからもっと簡潔にする。**
- 会話のモード追加
  - 日常会話（あるいはフランクな会話、旅行や交流を想定する感じ）と、丁寧な会話（いわゆるビジネス英語）を切り替えられるようにする。
  - これはteacherの会話文にも、フィードバックの部分にも影響する。
- **UIデザインの統一**
  - 会話部分と和訳部分のデザインが異なっている
  - どちらかのデザインに統一する（会話部分のチャット風UIが良さそう）
- **初期メッセージのバリエーション追加**
  - 現在は毎回同じ挨拶文が表示される
  - ランダムな挨拶やモードに応じたメッセージに変更
  - ここも生成AIを使うのが良いと思う。ただし専用のプロンプトが必要。
- **エラーハンドリングとリトライ機能の強化**
  - ネットワークエラー時の適切な処理
  - API呼び出し失敗時の自動リトライ機能
- **学習モード機能の完全な実装**
  - 現在は要件が不明確なため、学習モード選択機能を削除済み
  - 将来的には以下のような方向性を検討:
    - Quiz機能: 専用UIを作成し、現在の会話形式とは別画面で実装
    - Summary/Essay機能: 特定のトピックを与える機能として実装
    - 各モードの詳細な要件定義が必要

### 低優先度（機能拡張・カスタマイズ）
- システムメッセージの言語をすべて英語化
  - 先生の投稿待ちでは”Loading...”と英語で、システムメッセージは”会話がリセットされました"のように日本語で書かれている。混在させる理由はないので英語に統一する。
  - これはページ最上部にある”English Learning App”とかも同様。
## 設定機能

### 完全なconfig.json設定 ✅ (2024年12月)
アプリケーションはconfig/config.jsonファイルで包括的な設定管理を提供しています：

- **APIキー設定**: Anthropic、OpenAI、Azure OpenAI の各APIキー
- **プロキシ設定**: 企業環境でのHTTP/HTTPSプロキシ対応（標準ライブラリで実装）
- **エンドポイント設定**: カスタムAPIエンドポイントの指定
- **モデル設定**: 各プロバイダーで使用するモデル名の指定
- **サーバー設定**: ホスト、ポート、デバッグモード
- **UI設定**: デフォルトレベル、テーマ設定

### 環境変数対応 ✅ (2024年12月)
設定ファイルと環境変数の両方に対応し、環境変数が優先されます。
企業環境でのプロキシ設定も標準ライブラリのみで実現。

### 最小設定 ✅ (2024年12月)
APIキーのみの最小設定でも動作可能で、他の設定は自動的にデフォルト値が適用されます。
- 会話リセット時の表示を改善する
  - ”会話がリセットされました”が、先生の第一声の後にくる。もしこれをやるなら、順番が逆。
  - 画面全体がリセットされるだけなら、システムメッセージはなくてもいいかも。
  - あるいは、内部で会話履歴がなくなるだけで、過去のチャット履歴は見えたままでいいかも
    - 各トーク内容に対するIDの割り振りを変えないとダメ。
- **より柔軟なカスタマイズ機能**
  - ブラウザから生成AIのプロンプトを直接編集できる機能
  - 英語レベルの詳細設定（「TOEIC400点相当」→「日本の中学３年生レベル」など）
  - トピックの柔軟な指定（「インドに海外旅行する際の会話」など）
- **パフォーマンス最適化**
  - 翻訳・フィードバックのキャッシュ機能
  - 不要なDOM要素のクリーンアップ
  - メモリ使用量の最適化

### 命名・デザイン改善
- **AI Teacher の名前変更検討**
  - 現在の名前が安っぽく感じられる
  - より親しみやすく、学習意欲を高める名前を検討
  - 例：「Practice Partner」「English Buddy」「Learning Guide」など


# 対応履歴

## 2024年12月 リファクタリング完了 ✅

### ✅ **[完了]** プロジェクト全体のリファクタリング実施
- **実装内容**:
  - ファイル構造を整理し、適切なディレクトリ階層に再編成
  - バックエンドコードをモジュール化（config, backend ディレクトリ）
  - フロントエンドファイルを静的ファイル構造に移動（frontend/static/）
  - 設定管理を統合・改善（config/settings.py, config/config.json）
  - エントリーポイントを main.py に統一
  - JavaScriptコードをクラスベースに整理し、エラーハンドリングを改善
  - CSSを最新のベストプラクティスに合わせて更新（CSS Variables、レスポンシブデザイン）
  - 並列API呼び出しによるパフォーマンス改善
  - コードの可読性と保守性を向上
  - 今後の機能拡張がしやすい構造に変更
  - 基本動作確認完了（サーバー起動、API疎通確認済み）

### 📋 **リファクタリングで改善された点**:
1. **ファイル構造の改善**: 論理的なディレクトリ分割でコードの場所が明確に
2. **設定管理の統合**: 散在していた設定を config/ ディレクトリに集約
3. **モジュール化**: 各機能を独立したモジュールに分離し、再利用性向上
4. **エラーハンドリング**: より堅牢なエラー処理とユーザーフィードバック
5. **パフォーマンス**: 並列API呼び出しによる応答性向上
6. **保守性**: 今後の機能追加や修正がしやすい構造

## 高優先度タスク - 完了済み ✅

### ✅ **[完了]** どの英語テキストがどの和訳に対応しているかわかるようにする
- **実装内容**:
  - 各メッセージにユニークIDを割り振るシステムを実装（User-01, Teacher-01形式）
  - 会話パネルと和訳パネルで同じIDを表示して対応関係を明確化
  - LINEやDiscord風の控えめなIDラベルデザインを採用
  - ホバー効果は削除してシンプルな視覚的対応に変更

### ✅ **[完了]** エラーをはじめとしたシステムメッセージの表示を改善
- **実装内容**:
  - システムメッセージ専用のaddSystemMessage関数を追加
  - エラーメッセージやモード変更通知をAI Teacherのメッセージと区別
  - システムメッセージ用のCSSスタイルを追加
  - UI上での区別を明確化

### ✅ **[完了]** AI Teacherからのメッセージが返ってきた後にも"Loading..."の表示が残り続ける
- **実装内容**:
  - 各API呼び出し後に適切にhideLoadingを呼び出すよう修正
  - 和訳処理中も履歴は保持されるよう改善
  - ローディング状態の適切な管理を実装

### ✅ **[完了]** 画面右にあるフィードバックの際は、生徒のテキストだけじゃなく、直前の先生のテキストも含める
- **実装内容**:
  - フィードバック機能に先生のメッセージを文脈として含めるよう修正完了
  - translationHistoryの初期化バグも修正完了
  - フィードバックの品質向上を実現

### ✅ **[完了]** 和訳は生徒と先生の両方のテキストに対して実施する
- **実装内容**:
  - ユーザーのメッセージと先生のメッセージの両方を翻訳するよう修正
  - リセット時の初期メッセージも翻訳対象に含める
  - 並列処理を調整して効率的な翻訳処理を実現

### ✅ **[完了]** ローディング表示タイミングの最適化
- **実装内容**:
  - チャット画面のLoading表示を先生の回答表示直後に終了するよう修正
  - 和訳・フィードバックパネルに独立したLoading表示を追加
  - 各処理の進行状況を明確に表示し、ユーザー体験を向上
  - エラーハンドリングの分離により、より堅牢な処理を実現

### ✅ **[完了]** パネル表示の切り替え機能
- **実装内容**:
  - 和訳パネルとフィードバックパネルにトグルスイッチを追加
  - 直感的なON/OFF切り替えが可能なモダンなUIデザイン
  - パネル非表示時は斜線パターンのモザイク効果で背後のテキストを隠す
  - "Hidden"テキスト表示で非表示状態を明確化
  - 内部処理（和訳・フィードバック生成）は継続実行し、表示切り替え時に即座に結果表示
  - レスポンシブデザイン対応を維持

### ✅ **[完了]** ヒント機能の実装
- **実装内容**:
  - 会話パネルヘッダーに💡ヒントボタンを配置
  - モダンなポップアップUIで日本語→英語表現のヒント機能
  - `/api/hint`エンドポイントを追加し、AI駆動の英語表現提案
  - レベル別対応（TOEIC 400/600/800）で適切な語彙・文法使用
  - 複数表現提案機能（最大3つまで）と使い分けの解説
  - 用途外投稿への適切なエラーハンドリング
  - UIデザインの統一：Sendボタンを✈️アイコンに変更
  - テキストボックスとSendボタンの近接配置で操作性向上
  - レスポンシブデザイン対応（モバイル画面での縦並び表示）
  - Loading状態表示とエラーフィードバックの実装